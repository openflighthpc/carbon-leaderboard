<h1 class="mb-5"><%= @device.display_name %></h1>

<style>
table, th, td {
  border:1px solid black;
}
td {
  text-align: center;
}
</style>

<div class="cl-card flex-column-centred mb-4">
  <div class="device-type-wrapper">
    <%= image_tag 'logo.svg' %>
    <div>
      <% if @device.cloud_provider %>
        <h4><%= @device.cloud_provider %></h4>
        <span><%= @device.instance_type %></span>
      <% else %>
        <h4>On Premise</h4>
      <% end %>
    </div>
  </div>
  <div class="device-specs-wrapper">
    <div>
      <strong>CPU cores</strong>
      <span><%= @device.cpus * @device.cores_per_cpu %></span>
    </div>
    <div>
      <strong>GPUs</strong>
      <span><%= @device.gpus.length %></span>
    </div>
    <div>
      <strong>RAM</strong>
      <span><%= @device.ram %>GB</span>
    </div>
    <div>
      <strong>Mem</strong>
      <span><%= @device.total_memory %>GB</span>
    </div>
  </div>
</div>


<table style="width:100%" align="right">
  <tr>
    <th>Owner</th>
    <th>CPU name</th>
    <th>CPUs</th>
    <th>Cores Per CPU</th>
    <th>RAM Units</th>
    <th>RAM Capacity Per Unit</th>
    <th>Disks</th>
    <th>GPUs</th>
    <th>Carbon Usage (min)</th>
    <th>Carbon Usage (half)</th>
    <th>Carbon Usage (max)</th>
    <th>Platform</th>
    <th>Cloud Provider ID</th>
    <th>Instance Type</th>
    <th>Location</th>
    <th>Tags</th>
  </tr>
  <tr>
    <td><%= username(@device.user_id) %></td>
    <td><%= @device.cpu_name %></td>
    <td><%= @device.cpus %></td>
    <td><%= @device.cores_per_cpu %></td>
    <td><%= @device.ram_units %></td>
    <td><%= @device.ram_capacity_per_unit %></td>
    <td>
      <%=
      disk_string = ""
      @device.disks.each do |disk|
        disk_string << "#{disk['units']} x #{disk['capacity']}GB #{disk['type'].upcase}\n"
      end
      simple_format(disk_string)
      %>
    </td>
    <td><%= @device.gpus %></td>
    <td><%= @device.min %></td>
    <td><%= @device.half %></td>
    <td><%= @device.max %></td>
    <td><%= @device.platform %></td>
    <td><%= @device.cloud_provider %></td>
    <td><%= @device.instance_type %></td>
    <td><%= @device.location %></td>
    <td><%= @device.tags.join(", ") %></td>
  </tr>
</table>

<div class="full-width-section blurred-frame flex-column-centred">
  <h2>Live emissions</h2>
  <canvas id="live-emissions-chart" class="mb-5"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation/dist/chartjs-plugin-annotation.min.js"></script>
<script>
  const allData = <%= raw(@device.live_emissions_data.to_json) %>;
  const allTooltips = <%= raw(@device.live_emissions_tooltips.to_json) %>;
  const timeRange = <%= raw(@device.live_emissions_time_range.to_json) %>;
  const maxLoad = <%= raw(@device.max) %>;
  const halfLoad = <%= raw(@device.half) %>;
  const minLoad = <%= raw(@device.min) %>;
  const alcesBlue = '#2693D7';
  const borderColour = '#404040';
  const gridColour = '#FFFFFF';
  const loadLineColor = '#8c9cad';

  const ctx = document.getElementById('live-emissions-chart');
  let chart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [{
        data: allData,
        borderWidth: 2,
        tooltips: allTooltips,
      }]
    },
    options: {
      clip: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Equivalent CO2 emissions (kg/h)',
            font: {
              size: 20,
            },
            padding: {
              bottom: 20
            }
          },
          ticks: {
            font: {
              size: 16,
            },
            maxTicksLimit: 8
          },
          grid: {
            color: gridColour
          },
          border: {
            color: borderColour
          }
        },
        x: {
          ticks: {
            color: "#666",
            font: {
              size: 16,
              weight: 'normal',
            }
          },
          grid: {
            color: gridColour
          },
          border: {
            color: borderColour
          },
          type: 'time',
          time: {
            unit: 'day',
            displayFormats: {
              'day': 'd MMM yy',
              'week': 'DD.MM',
              'month': 'do MMM',
              'year': 'MMMM',
            },
          },
          min: timeRange[0],
          max: timeRange[1],
        }
      },
      elements: {
        point: {
          pointBorderColor: alcesBlue,
          pointBorderWidth: 4,
          pointBackgroundColor: '#ffffff',
          pointRadius: 5,
          pointHitRadius: 5
        }
      },
      plugins: {
        clip: false,
        annotation: {
          annotations: {
            max: loadAnnotation(maxLoad, 'Max load'),
            half: loadAnnotation(halfLoad, 'Half load'),
            min: loadAnnotation(minLoad, 'Min load'),
          }
        },
        legend: {
          display: false
        },
        tooltip: {
          displayColors: false,
          bodyAlign: 'center',
          yAlign: 'bottom',
          bodyFont: {
            size: 16
          },
          callbacks: {
            title: function () {
              return ""
            },
            label: function (context) {
              return context.dataset.tooltips[context.dataIndex];
            }
          }
        }
      }
    }
  });

  function loadAnnotation(val, label) {
    return {
      type: 'line',
      yMin: val,
      yMax: val,
      borderColor: loadLineColor,
      borderWidth: 2,
      borderDash: [3, 3],
      label: {
        display: true,
        content: label,
        position: 'end',
        backgroundColor: 'transparent',
        color: loadLineColor,
        font: {
          size: 16,
          weight: 'light',
        },
        yAdjust: -12,
      }
    }
  }
</script>
